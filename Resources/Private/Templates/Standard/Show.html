<f:layout name="Main" />

<f:section name="header">
	<script>
		Timeline_ajax_url="{f:uri.resource(path:'timeline_2.3.0/timeline_ajax/simile-ajax-api.js')}";
		Timeline_urlPrefix="{f:uri.resource(path:'timeline_2.3.0/timeline_js/')}";
		Timeline_parameters='bundle=true';
	</script>
	<script src="{f:uri.resource(path:'timeline_2.3.0/timeline_js/timeline-api.js')}" type="text/javascript"></script>

	<script type="text/javascript" src="../../../Public/DataTables/media/js/jquery.js"></script>
	<script type="text/javascript">
		var numberOfProfiles = {numberOfProfiles};
		<![CDATA[
		jQuery(document).ready(function($) {
			// TODO: if we need to define custom date/time intervals, we can do as shown here:
			// http://www.nickrabinowitz.com/projects/timemap/opencontext/oc.js


			// Adjust Millisecond rendering in timeline
			var originalLabellerFunction = Timeline.GregorianDateLabeller.prototype.defaultLabelInterval;
			Timeline.GregorianDateLabeller.prototype.defaultLabelInterval = function(date, intervalUnit) {
				// call original function if we're not dealing with new unit
				if (intervalUnit === Timeline.DateTime.MILLISECOND) {
					var emphasized = (date.getTime() % 1000 === 0);
					return {emphasized: emphasized, text:date.getTime()};
				} else {
					return originalLabellerFunction.call(this, date, intervalUnit);
				}
			};

			// Adjust info bubble
			Timeline.DefaultEventSource.Event.prototype.fillInfoBubble = function(elmt, theme, labeller) {
				console.log(this);
				$(elmt).append(jQuery('<h2>' + this._title + '</h2>'));
				$(elmt).append(jQuery('<div>' + this._start.getTime() + ' ms - ' + this._end.getTime() + 'ms </div>'));

				var tableCells = '';
				jQuery.each(this._description, function(key, value) {
					tableCells += '<tr><th>' + key + '</th><td>' + value + '</td></tr>';
				});
				if (tableCells.length) {
					$(elmt).append(jQuery('<table>' + tableCells + '</table>'));
				}
			};


			// Set up timeline
			var eventSource = new Timeline.DefaultEventSource();
			var theme = Timeline.ClassicTheme.create();
			theme.event.tape.height = 10;
			theme.autoWidth = true;

			var bandInfos = [
				Timeline.createBandInfo({
					width:          "85%",
					intervalUnit:   Timeline.DateTime.MILLISECOND,
					multiple: 100,
					intervalPixels: 1,
					eventSource:    eventSource,
					date: new Date(0),
					theme: theme
				}),
				Timeline.createBandInfo({
					width:          "15%",
					intervalUnit:   Timeline.DateTime.SECOND,
					intervalPixels: 100,
					eventSource:    eventSource,
					overview: true
				})
			];
			bandInfos[1].syncWith = 0;
			bandInfos[1].highlight = true;

			if (numberOfProfiles === 2) {
				// TODO: clean up the mess below
				var eventSource2 = new Timeline.DefaultEventSource();
				bandInfos[2] = bandInfos[1];
				bandInfos[1] = Timeline.createBandInfo({
					width:          "85%",
					intervalUnit:   Timeline.DateTime.MILLISECOND,
					multiple: 100,
					intervalPixels: 1,
					eventSource:    eventSource2,
					date: new Date(0),
					theme: theme
				});
				bandInfos[3] = Timeline.createBandInfo({
					width:          "15%",
					intervalUnit:   Timeline.DateTime.SECOND,
					intervalPixels: 100,
					eventSource:    eventSource2,
					overview: true
				});

				bandInfos[3].syncWith = 1;
				bandInfos[3].highlight = true;
			}

			tl = Timeline.create($('#timeline').get(0), bandInfos);

			]]>

			{js -> f:format.raw()}

			eventSource = eventSource2;

			{js2 -> f:format.raw()}

			tl.layout();
		});


	</script>
</f:section>
<f:section name="navigation">
	<li><f:link.action action="index">Overview</f:link.action></li>
	<li class="active"><a>Timeline View</a></li>
	<li><a>XHProf View</a></li>
</f:section>

<f:section name="content">
	<div id="timeline" style="height: 600px; width:90%; border: 1px solid #aaa">

	</div>
</f:section>
<html>
	<head>
		<meta charset="utf-8">
		<title>Index view of Standard controller</title>
		<f:base />

	</head>
	<body>

	</body>
</html>